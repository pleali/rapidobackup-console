# OpenAPI Code-First Development Guide

This project now uses a **Code-First** approach with automatic TypeScript client generation from Spring annotations.

## Architecture

```
Spring Annotations + SpringDoc  ‚Üí  OpenAPI 3.0 Specification
    ‚Üì
src/main/resources/openapi/api.yml  (generated from annotations)
    ‚Üì
Maven openapi-generator-plugin  ‚Üí  Automatic TypeScript client generation
    ‚Üì
src/main/webapp/src/lib/generated/  ‚Üí  Generated TypeScript client
```

## File Structure

### OpenAPI Specification (Generated)
- **`src/main/resources/openapi/api.yml`** - Specification generated automatically from Spring annotations
- **‚ö†Ô∏è IMPORTANT**: This file is automatically generated, do not modify manually

### Generated TypeScript Client
- **`src/main/webapp/src/lib/generated/`** - TypeScript client with complete types
  - `api.ts` - TypeScript client with complete types
  - `index.ts` - Main exports
  - `configuration.ts` - Client configuration
- **‚ö†Ô∏è IMPORTANT**: These files are automatically generated and excluded from Git

### Integration Code (Manual)
- **`src/main/webapp/src/lib/generated-api-client.ts`** - Example usage of the generated client
- **‚úÖ This file** is maintained manually and versioned in Git

## Development Commands

### Code Generation
```bash
# Complete generation: API spec + TypeScript client
.\mvnw.cmd clean compile -Dopenapi.client.skip=false

# Normal compilation without regenerating client (faster)
.\mvnw.cmd compile

# Build frontend with TypeScript client
npm run build
```

### Code-First Development Cycle
1. **Modify** SpringDoc annotations in your Java controllers
2. **Compile** the project with generation enabled: `.\mvnw.cmd compile -Dopenapi.client.skip=false`
3. **TypeScript client** automatically regenerated and available
4. **Test** the application: `.\mvnw.cmd spring-boot:run`

## Swagger UI Documentation

The Swagger UI interface is accessible in development mode at:
- **http://localhost:8080/swagger-ui.html**

This interface is automatically generated by `springdoc-openapi-starter-webmvc-ui`.

## Migration from Manual API

### Step 1: Java Controllers
Controllers already use SpringDoc annotations for automatic documentation:

```java
@RestController
@Tag(name = "Authentication", description = "User authentication and session management")
public class AuthController {

    @PostMapping("/login")
    @Operation(summary = "User login", description = "Authenticate user with login/password")
    public ResponseEntity<UserDto> login(@Valid @RequestBody LoginRequest loginRequest) {
        // Your existing implementation
    }
}
```

### Step 2: TypeScript Client
Replace manual API calls with the generated client:

```typescript
// Before (manual)
import { loginUser } from './api';

// After (generated)
import { loginUserGenerated } from './generated-api-client';
```

## Advantages of Code-First Approach

### üîí Type Safety
- **Java**: DTOs and SpringDoc annotations in source code
- **TypeScript**: Complete types automatically generated for all API calls

### üìù Documentation
- **Swagger UI**: Interactive interface automatically generated from annotations
- **JSDoc**: Comments generated in TypeScript code from Java annotations

### üîÑ Synchronization
- **Single Source of Truth**: Java annotations as unique reference
- **Consistency**: Frontend always synchronized with backend automatically

### ‚ö° Productivity
- **Code-First**: Natural development in Java with annotations
- **Automatic Generation**: TypeScript client always up to date
- **Validation**: Automatic validation based on Jakarta annotations

## Best Practices

### 1. Organize Controllers
```java
// Separate by modules with @Tag
@Tag(name = "Authentication", description = "User authentication and session management")
@RequestMapping("/api/auth")

@Tag(name = "Agents", description = "Agent management and communication")
@RequestMapping("/api/agents")

@Tag(name = "Users", description = "User management and hierarchy")
@RequestMapping("/api/users")
```

### 2. Versioning
- Use versions in URL: `/api/v1/auth/login`
- Maintain backward compatibility with previous versions

### 3. Security
- Use `@SecurityRequirement` on protected endpoints
- Document required permissions with `@Operation`

### 4. Validation
- Use Jakarta Validation annotations (`@Valid`, `@NotNull`, etc.)
- SpringDoc automatically generates OpenAPI constraints

## Maven Configuration

### SpringDoc Plugin (OpenAPI Extraction)
```xml
<plugin>
    <groupId>org.springdoc</groupId>
    <artifactId>springdoc-openapi-maven-plugin</artifactId>
    <version>1.4</version>
    <!-- Extracts api.yml from Spring Boot application -->
</plugin>
```

### OpenAPI Generator Plugin (TypeScript Client)
```xml
<plugin>
    <groupId>org.openapitools</groupId>
    <artifactId>openapi-generator-maven-plugin</artifactId>
    <version>7.10.0</version>
    <!-- Generates TypeScript client from api.yml -->
</plugin>
```

### Important Options
- **`typescript-axios`** - TypeScript client generator with Axios
- **`supportsES6: true`** - Support for ES6+ and modern TypeScript
- **`withInterfaces: true`** - Generates TypeScript interfaces

## Troubleshooting

### Java Compilation Error
```bash
# Clean and regenerate
.\mvnw.cmd clean generate-sources compile
```

### TypeScript Client Not Found
```bash
# Check generation
ls src/main/webapp/src/lib/generated/
```

### Swagger UI Not Accessible
- Check that `springdoc-openapi-starter-webmvc-ui` is in dependencies
- Start application in dev mode: `.\mvnw.cmd spring-boot:run`

## Next Steps

1. **Extend API**: Add SpringDoc annotations to agents, users modules
2. **Migrate frontend**: Replace manual API calls with generated client
3. **Tests**: Create tests based on generated interfaces
4. **CI/CD**: Integrate automatic generation into build pipeline
5. **Documentation**: Use Swagger UI for interactive documentation

## Current Status ‚úÖ

- ‚úÖ SpringDoc configuration for automatic `api.yml` generation
- ‚úÖ OpenAPI Generator plugin for TypeScript client
- ‚úÖ Git exclusion of generated files
- ‚úÖ Complete build cycle working
- ‚úÖ TypeScript client generated with complete types for authentication